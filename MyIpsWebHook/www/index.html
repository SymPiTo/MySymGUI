<!doctype html>

<html>

<head>
    <title>MyIPS</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HomeControl GUI.">



    <link rel="stylesheet" type="text/css" href="css/myGlides.css">
    <link rel="stylesheet" href="css/flipclock.css">

    <!--  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>   -->
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>

    <script src="js/moment.min.js"></script>
    <script src="js/Chart.min.js"></script>

    <script src="js/myGlides.js"></script>
    <script src="js/myCommands.js"></script>
    <script src="js/myVars.js"></script>
    <script src="js/myLib.js"></script>
    <script src="js/data.js"></script>
    <script src="js/iconSet.js"></script>

    <script src="js/ips_functions.js"></script>

    <script src="js/flipclock.js"></script>

    <!--  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script> -->


    <!--  <link href="http://allfont.net/allfont.css?fonts=dot-matrix" rel="stylesheet" type="text/css"> -->


    <!-- <link rel="stylesheet" type="text/css"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"> -->


    <!-- <link rel="stylesheet" type="text/css" href="line-awesome/css/line-awesome.min.css">  -->
    <link rel="stylesheet" type="text/css" href="css/fontawesome_5-10-2/css/all.css">
    <link rel="shortcut icon" href="images/favicon.ico">

    <!--  ..............................................................  -->
    <!--   WEBSOCKET FUNKTIONEN                                           -->
    <!--  ..............................................................  -->
    <script type='text/javascript'>
        var socket;

        var symvar = [];


        var ipsArray = [];
        var symArray = new Array(400).fill("");
        var ipsObj = new ipsbuffer(ipsArray, symArray);


        function init() {
            var authToken = "tboercskten";



            //var host = 'wss://192.168.178.28:9000/?auth=' + authToken;

            //?key1=value1&key2=value2 

            var host = 'ws://192.168.178.28:9000/?auth=' + authToken; // SET THIS TO YOUR SERVER
            try {
                socket = new WebSocket(host);
                state('WebSocket: ' + socket.readyState);

                socket.onopen = function (msg) {
                    var a = 0;
                    if (this.readyState === 1) {
                        a = 'connected';
                        //Restartversuchszaehler zurücksetzen
                        versuch = false;

                    } else if (this.readyState === 2) {
                        a = 'connecting';
                    } else if (this.readyState === 0) {
                        a = 'not connecting';
                    } else {
                        a = 'Connection closed';
                    }
                    state(' WebSocket: ' + a);
                    errorbox.add(' WebSocket onOpen: ' + a);
                    //keepAlive();
                };

                socket.onmessage = function (msg) {
                    var jsontext = msg.data;


                    if (ipsObj.first) {
                        //Ausführung beim Ersten AUfruf der Webseite  

                        ipsObj.first = false;
                        //alle verwendete IPS Variable Definieren - mit "" beschreiben
                        ipsObj.init();
                    }

                    if (jsontext.substring(0, 6) == "REPLY:") {

                        var feedback = jsontext.substr(6, jsontext.length - 6);
                        reply(feedback);
                    } else if (jsontext.substring(0, 6) == "AList:") {

                        var text = jsontext.substr(6, jsontext.length - 6);
                        showAList(text);
                    } else if (jsontext.substring(0, 9) == "IPSValue:") {
                        //Antwort auf eine Anfrage - nur bestimmte Variable updaten
                        var ipsID = "ID" + jsontext.substring(10, 5);
                        var len = jsontext.length - 14;
                        var ipsJsonValue = jsontext.substring(16, len);
                        var IPSValue = JSON.parse(ipsJsonValue);
                        updateIPSValue(ipsID, IPSValue);

                    } else {
                        if (jsontext != "") {
                            //Variablen Paket einlesen
                            var paket = ips[1];
                            ips = JSON.parse(jsontext);
                            symvar = ips[0];
                            //eingelesene Datenpakete/Werte in die IPS variablen schreiben
                            //=> update der IPS Variablen
                            ipsObj.update(symvar);
                            //console.log(ipsObj.ips);
                            //Counter für empfangene Daten Pakete anzeigen auf Kopfleiste
                            //log(ips[0]);
                            //IPS Variable den Anzeige Variablen zuordnen
                            ipsObj.check();
                            //Anzeige der aktuellen Werte
                            Heizung();
                            Security();
                            Klima();
                            updateValues();
                        }
                    }

                };
                socket.onclose = function (event) {
                    //////state('Client disconnected - status ' + this.readyState);

                    //send('Client' + '*' + 'status' + '*' + 'close connection');
                    // See http://tools.ietf.org/html/rfc6455#section-7.4.1
                    if (event.code == 1000)
                        reason = "verbindung geschlossen";
                    // "Normal closure, meaning that the purpose for which the connection was established has been fulfilled.";
                    else if (event.code == 1001)
                        reason = "Server down";
                    //"An endpoint is \"going away\", such as a server going down or a browser having navigated away from a page.";
                    else if (event.code == 1002)
                        reason = "Protokoll Fehler";
                    //"An endpoint is terminating the connection due to a protocol error";
                    else if (event.code == 1003)
                        reason = "falscher Daten Typ";
                    //"An endpoint is terminating the connection because it has received a type of data it cannot accept (e.g., an endpoint that understands only text data MAY send this if it receives a binary message).";
                    else if (event.code == 1004)
                        reason = "Reserved. The specific meaning might be defined in the future.";
                    else if (event.code == 1005)
                        reason = "Status unbekannt";
                    //"No status code was actually present.";
                    else if (event.code == 1006)
                        reason = "Absturz der Verbindung";
                    //"The connection was closed abnormally, e.g., without sending or receiving a Close control frame";
                    else if (event.code == 1007)
                        reason = "falsches data format";
                    //"An endpoint is terminating the connection because it has received data within a message that was not consistent with the type of the message (e.g., non-UTF-8 [http://tools.ietf.org/html/rfc3629] data within a text message).";
                    else if (event.code == 1008)
                        reason = "Policy Verletzung";
                    //"An endpoint is terminating the connection because it has received a message that \"violates its policy\". This reason is given either if there is no other sutible reason, or if there is a need to hide specific details about the policy.";
                    else if (event.code == 1009)
                        reason = "Message zu groß";
                    //"An endpoint is terminating the connection because it has received a message that is too big for it to process.";
                    else if (event.code == 1010)
                        // Note that this status code is not used by the server, because it can fail the WebSocket handshake instead.
                        reason = "Extension fehlt";
                    // "An endpoint (client) is terminating the connection because it has expected the server to negotiate one or more extension, but the server didn't return them in the response message of the WebSocket handshake. <br /> Specifically, the extensions that are needed are: " +
                    else if (event.code == 1011)
                        reason = "unerwarteter Zustand";
                    // "A server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request.";
                    else if (event.code == 1015)
                        reason = "Zertifikat Fehler";
                    //"The connection was closed due to a failure to perform a TLS handshake (e.g., the server certificate can't be verified).";
                    else
                        reason = "Unknown reason";
                    //fehler('Client closed:' + reason);
                    state(' WebSocket: ' + reason);
                    errorbox.add('Websocket OnClose: ' + reason);
                    state(' WebSocket: ' + socket.readyState);
                    if (event.code == 1006) {
                        if (versuch == false) {
                            //Versuch den Client neu zu starten.
                            errorbox.add('Websocket OnClose: ' + 'Restart Versuch');
                            reconnect();
                            versuch = true;
                        } else {

                            errorbox.add('Websocket OnClose: ' + ' Restart Versuch gescheitert.');
                        }


                    }
                    //cancelKeepAlive();
                    //led.update(false);
                };
                socket.onerror = function (error) {
                    //fehler('Client' + '*' + 'status' + '*' + error.data);
                    //fehler('Fehler:' + error.message);
                    state(' Websocket OnError: ' + error.message);
                    errorbox.add(error.message);


                };
            } catch (ex) {
                state(ex);
            }
            //$('msg').focus();	
        }


        function send(msg) {
            var msg;

            if (!msg) {
                alert('Message can not be empty');
                return;
            }

            try {
                socket.send(msg);
                //cmd('Sent: '+msg); 
            } catch (ex) {
                state(ex);
            }
        }

        function quit() {
            if (socket !== null) {
                state('Client quit!');
                socket.close();
                socket = null;
            }
        }

        function reconnect() {
            quit();
            init();
        }


        var timerID = 0;

        function keepAlive() {
            var timeout = 20000;
            if (socket.readyState == socket.OPEN) {
                send('Client' + '*' + 'status' + '*' + 'keep Alive');
            }
            timerID = setTimeout(keepAlive, timeout);

        }


        function cancelKeepAlive() {
            if (timerID) {
                clearTimeout(timerID);

            }
        }


        function fehler(msg) {

            $('TopTitle').innerHTML = "";
            $('fehler').innerHTML = msg;
        }


        // Utilities
        function $(id) {
            return document.getElementById(id);
        }

        function state(msg) {
            $('state').innerHTML = msg;
        }

        function cmd(msg) {
            $('cmd').innerHTML = msg;
        }



        function close(msg) {
            if (msg === doclose) {
                quit();
            } else {}
        }

        var z = 0;

        function log(msga) {
            z = z + 1;
            $('log').innerHTML = z.toString();
        }


        function log15(msg) {
            $('prog').innerHTML = msg;
        }


        function read_json() {
            $.getJSON("/TVchalles.json", function (data) {
                alert("My data: " + data["mydata"]);
                $.each(data["prime"], function (idx, prime) {
                    alert("Prime number: " + prime);
                });
            });
        }


        function HzWZan() {
            document.getElementById("test").classList.toggle('cyan');
            document.getElementById("test").classList.toggle('cyanA');


        }



        function VarsNetwork(ips) {
            $('ws1').innerHTML = ips[0].WS0001 + ' connected: ' + ips[0].WS0011;
            $('ws2').innerHTML = ips[0].WS0002 + ' connected: ' + ips[0].WS0021;
            $('ws3').innerHTML = ips[0].WS0003 + ' connected: ' + ips[0].WS0031;
            document.getElementById('servericon').src = ips[0].ID10960;
            document.getElementById('clienticon').src = ips[0].ID12017;
        }
    </script>

</head>

<body onload='init();'>
    <!--                            Meldefenster überlagernd                     -->


    <script>
        var Meldung = new Message();
        Meldung.create("body", "7vh", "40vw", "350px", "120px", "info", "13996", "-");
    </script>

    <!-- ----------------------------------------------------------------------- -->
    <!--                            Gesamt Container                             -->
    <!-- ----------------------------------------------------------------------- -->

    <div id="Container" class="Container">
        <!-- ----------------------------------------------------------------------- -->
        <!--                           KopfLeiste                                    -->
        <!-- ----------------------------------------------------------------------- -->
        <div id="kopfleiste" class="Top">


        </div>


        <!-- ----------------------------------------------------------------------- -->
        <!--                           Haupt Menues                                  -->
        <!-- ----------------------------------------------------------------------- -->

        <mainMenu id="MainMenu" class="Left"> </mainMenu>

        <script>
            var MenuHome = new GlideButton();
            MenuHome.create("MainMenu", "grey", "Home", home, "MenuStart", "", "R");
            var LeftMenuFP = new GlideButton();
            LeftMenuFP.create("MainMenu", "pink", "Floorplan", floorplan, "", "floorplan", "MM");
            var LeftMenuSec = new GlideButton();
            LeftMenuSec.create("MainMenu", "red", "Alarmanlage", alarm, "MenuSec", "", "MM");
            var LeftMenuWZ = new GlideButton();
            LeftMenuWZ.create("MainMenu", "cyan", "Wohnzimmer", wohnzimmer, "MenuWZ", "", "MM");
            var LeftMenuKZ = new GlideButton();
            LeftMenuKZ.create("MainMenu", "olive", "Kinderzimmer", kinderzimmer, "MenuKZ", "", "MM");
            var LeftMenuSZ = new GlideButton();
            LeftMenuSZ.create("MainMenu", "sandy", "Schlafzimmer", schlafzimmer, "MenuSZ", "", "MM");
            var LeftMenuK = new GlideButton();
            LeftMenuK.create("MainMenu", "midgreen", "Kueche", kueche, "MenuK", "", "MM");
            var LeftMenuB = new GlideButton();
            LeftMenuB.create("MainMenu", "blue", "Balkon", balkon, "MenuB", "", "MM");
            var LeftMenuBad = new GlideButton();
            LeftMenuBad.create("MainMenu", "violet", "Bad", bad, "MenuBad", "", "MM");
            var LeftMenuDiele = new GlideButton();
            LeftMenuDiele.create("MainMenu", "yellowgreen", "Diele", diele, "MenuDiele", "", "MM");

            var LeftMenuAZ = new GlideButton();
            LeftMenuAZ.create("MainMenu", "orangerot", "Arbeitsbereich", arbeitszimmer, "MenuAZ", "", "MM");

            var LeftMenuMM = new GlideButton();
            LeftMenuMM.create("MainMenu", "purple", "Multimedia", multimedia, "MenuMultimedia", "", "MM");
            var LeftMenuHz = new GlideButton();
            LeftMenuHz.create("MainMenu", "yellow", "Heizung", heizung, "MenuHz", "", "MM");
            var LeftMenuRollo = new GlideButton();
            LeftMenuRollo.create("MainMenu", "brown", "Rolladen", rolladen, "MenuRollo", "", "MM");
            var LeftMenuNet = new GlideButton();
            LeftMenuNet.create("MainMenu", "green", "Netzwerk", network, "MenuNet", "", "MM");



            var MenuSecurity1 = new GlideButton();
            MenuSecurity1.create("MainMenu", "cyan", "none", network, "MenuNone", "", "MM");
        </script>






        <!-- ************************** Platzhalter für dynamische nachladen von Seiten ************************** -->
        <div id="Main"></div>
        <!-- ************************** Platzhalter für dynamische nachladen von Seiten ************************** -->

    </div>

    <!-- ************************** Container Ende ************************** -->

    </div>

    <!--  ************************** Container Ende  ************************** -->




</body>






</html>